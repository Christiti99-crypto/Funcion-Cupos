<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Completo de Cupos GAD</title>
    <!-- WebR -->
    <script src="https://webr.r-wasm.org/latest/webr.js"></script>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <style>
        .chart-container { height: 400px; margin-bottom: 2rem; }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .progress {
            width: 80%;
            margin-top: 20px;
        }
        #r-output {
            height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h4 class="mt-3">Inicializando R y ejecutando análisis...</h4>
        <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%"></div>
        </div>
        <div id="r-output"></div>
    </div>

    <!-- Contenido principal (oculto inicialmente) -->
    <div class="container-fluid" id="mainContent" style="display: none;">
        <header class="bg-primary text-white p-4 mb-4">
            <h1>Sistema de Determinación de Cupos</h1>
            <p class="lead">Análisis completo de capacidad de endeudamiento</p>
        </header>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Valores Presentes por GAD</h5>
                    </div>
                    <div class="card-body">
                        <div id="chartVP" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Distribución por Estratos</h5>
                    </div>
                    <div class="card-body">
                        <div id="chartEstratos" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>GADs que Necesitan Ajuste</h5>
            </div>
            <div class="card-body">
                <div id="problematicGADs" class="table-responsive"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>Optimizador de Cupos</h5>
            </div>
            <div class="card-body">
                <button id="runOptimizer" class="btn btn-primary">Ejecutar Optimización</button>
                <div id="optimizerResults" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Nuestro script principal -->
    <script>
        // Variables globales
        let webRReady = false;
        let analysisData = {};
        const rOutput = document.getElementById('r-output');
        
        // Función para actualizar progreso
        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            if (message) {
                rOutput.innerHTML += `> ${message}<br>`;
                rOutput.scrollTop = rOutput.scrollHeight;
            }
        }
        
        // Función para ejecutar código R y mostrar resultados
        async function runRCode(code) {
            try {
                const result = await webR.evalR(code);
                const jsResult = await result.toJs();
                result.destroy();
                return jsResult;
            } catch (error) {
                rOutput.innerHTML += `ERROR: ${error.message}<br>`;
                return null;
            }
        }
        
        // Función para inicializar R y ejecutar análisis
        async function initializeR() {
            updateProgress(10, "Inicializando WebR...");
            
            // Configurar WebR
            webR = new WebR();
            await webR.init();
            webRReady = true;
            
            updateProgress(20, "Instalando paquetes necesarios...");
            
            // Instalar paquetes necesarios
            await runRCode(`
                if (!requireNamespace("dplyr", quietly = TRUE)) {
                    install.packages("dplyr")
                }
                if (!requireNamespace("jsonlite", quietly = TRUE)) {
                    install.packages("jsonlite")
                }
                library(dplyr)
            `);
            
            updateProgress(30, "Cargando funciones de análisis...");
            
            // Definir todas las funciones R directamente en el navegador
            await runRCode(`
                # FUNCIÓN 1: EJECUTAR SCRIPT COMPLETO
                ejecutar_script_cupos_completo <- function() {
                    # [Aquí va el contenido completo de tu función original]
                    # Versión simplificada para ejemplo:
                    data_vp <- data.frame(
                        gad = c("GAD 1", "GAD 2", "GAD 3"),
                        Estrato = c(1, 2, 3),
                        vp10_25 = c(100000, 150000, 200000),
                        coplafip10 = c(0, 1, 1)
                    )
                    return(data_vp)
                }
                
                # FUNCIÓN 2: DETECTAR GAD PROBLEMÁTICOS
                detectar_gad_atencion <- function(data) {
                    # [Implementación simplificada]
                    list(
                        gad_atencion = data[data$coplafip10 == 1,],
                        total_gad = nrow(data)
                    )
                }
                
                # [Agregar aquí todas tus otras funciones...]
            `);
            
            updateProgress(50, "Ejecutando análisis principal...");
            
            // Ejecutar análisis principal
            analysisData.data_vp = await runRCode('ejecutar_script_cupos_completo()');
            
            updateProgress(70, "Identificando GADs problemáticos...");
            
            // Obtener GADs problemáticos
            const problematicResult = await runRCode(`
                detectar_gad_atencion(data_vp)
            `);
            analysisData.problematicGADs = problematicResult.gad_atencion;
            
            updateProgress(90, "Preparando visualizaciones...");
            
            // Mostrar resultados
            renderResults();
            
            updateProgress(100, "¡Análisis completado!");
            
            // Ocultar pantalla de carga después de 1 segundo
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }, 1000);
        }
        
        // Función para renderizar resultados
        function renderResults() {
            // Gráfico de Valores Presentes
            Highcharts.chart('chartVP', {
                chart: { type: 'bar' },
                title: { text: 'Valor Presente (10 años) por GAD' },
                xAxis: { categories: analysisData.data_vp.map(item => item.gad) },
                yAxis: { title: { text: 'Valor Presente' } },
                series: [{
                    name: 'VP10_25',
                    data: analysisData.data_vp.map(item => item.vp10_25)
                }]
            });
            
            // Gráfico por estratos
            Highcharts.chart('chartEstratos', {
                chart: { type: 'column' },
                title: { text: 'Distribución por Estratos' },
                xAxis: { 
                    categories: ['Estrato 1', 'Estrato 2', 'Estrato 3', 'Estrato 4', 'Estrato 5'] 
                },
                yAxis: { title: { text: 'Cantidad de GADs' } },
                series: [{
                    name: 'Total GADs',
                    data: [5, 8, 12, 7, 3] // Datos de ejemplo
                }, {
                    name: 'Con problemas',
                    data: [2, 3, 1, 0, 1] // Datos de ejemplo
                }]
            });
            
            // Tabla de GADs problemáticos
            const tableHTML = `
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>GAD</th>
                            <th>Estrato</th>
                            <th>Valor Presente</th>
                            <th>Problema</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisData.problematicGADs.map((gad, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${gad.gad}</td>
                                <td>${gad.Estrato}</td>
                                <td>${gad.vp10_25.toLocaleString()}</td>
                                <td><span class="badge bg-danger">Requiere ajuste</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('problematicGADs').innerHTML = tableHTML;
        }
        
        // Evento para ejecutar optimizador
        document.getElementById('runOptimizer').addEventListener('click', async function() {
            if (!webRReady) {
                alert("R no está listo todavía. Por favor espere.");
                return;
            }
            
            const optimizerResults = document.getElementById('optimizerResults');
            optimizerResults.innerHTML = '<div class="spinner-border text-primary" role="status"></div> Ejecutando optimización...';
            
            // Ejecutar función de optimización en R
            const result = await runRCode(`
                optimizar_gads_automatico(mostrar_progreso = FALSE)
            `);
            
            if (result && result.gads_optimizados) {
                optimizerResults.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Optimización completada</h5>
                        <p>GADs optimizados: ${result.gads_optimizados.length}</p>
                        <p>GADs no optimizables: ${result.gads_no_optimizables.length}</p>
                    </div>
                `;
            } else {
                optimizerResults.innerHTML = `
                    <div class="alert alert-danger">
                        Error en el proceso de optimización
                    </div>
                `;
            }
        });
        
        // Iniciar todo cuando se cargue la página
        document.addEventListener('DOMContentLoaded', initializeR);
    </script>
</body>
</html>
